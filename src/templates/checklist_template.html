<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ month }}ì›” ì¦ë¹™ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; padding: 20px; }
        h2 { text-align: center; margin-bottom: 20px; color: #333; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding: 15px; 
            background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;
        }
        .mode-group label { margin-right: 15px; cursor: pointer; font-weight: bold; color: #555; }
        
        .btn-group button { 
            padding: 8px 16px; border: none; border-radius: 6px; 
            cursor: pointer; font-weight: bold; margin-left: 8px;
        }
        .btn-save { background: #007bff; color: white; } 
        .btn-reset { background: #ff6b6b; color: white; } 
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 10px 8px; text-align: center; }
        th { background-color: #e9ecef; height: 40px; }
        
        .period { font-weight: bold; color: #0056b3; }
        .col-idx { background: #f8f9fa; color: #868e96; }
        .reason-cell { text-align: left; padding-left: 15px; }
        
        /* ë±ƒì§€ */
        .time-badge {
            display: inline-block; background-color: #e3f2fd; color: #0d47a1;
            padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;
            margin-left: 6px;
        }
        
        /* ìƒíƒœë³„ í–‰ ìŠ¤íƒ€ì¼ */
        tr.submitted { background: #d4edda !important; color: #155724; } /* DB ì™„ë£Œ */
        tr.completed { background: #f1f3f5; } /* í™”ë©´ ì²´í¬ */
        
        /* ë³´ê¸° ëª¨ë“œ */
        tr.completed.mode-strike { text-decoration: line-through; color: #adb5bd; }
        tr.completed.mode-hide { display: none; }
        tr.submitted.mode-hide { display: none; }
    </style>
    <script>
        const KEY = "{{ storage_key }}";
        let mode = 'strike'; 

        window.onload = () => load();

        function setMode(m) { 
            mode = m; 
            updateView(); 
            saveState(); 
        }

        function toggle(cb, id) {
            const row = document.getElementById(id);
            if (cb.checked) row.classList.add('completed');
            else row.classList.remove('completed');
            updateView(); 
            saveState();
        }

        function updateView() {
            document.querySelectorAll('tr.data-row').forEach(row => {
                row.classList.remove('mode-strike', 'mode-hide');
                
                // ì™„ë£Œë˜ì—ˆê±°ë‚˜(í™”ë©´ì²´í¬) ì œì¶œëœ(DB) ê²½ìš°
                if (row.classList.contains('completed') || row.classList.contains('submitted')) {
                    if (row.classList.contains('submitted') && mode === 'hide') {
                        row.classList.add('mode-hide');
                    } else if (row.classList.contains('completed')) {
                        row.classList.add('mode-' + mode);
                    }
                }
            });
        }

        function saveState() {
            const state = { mode: mode, checked: [] };
            document.querySelectorAll('.chk:not(:disabled)').forEach((cb) => {
                if(cb.checked) {
                    // data-rid ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ì¸ë±ìŠ¤ ì €ì¥
                    state.checked.push(cb.getAttribute('data-rid'));
                }
            });
            localStorage.setItem(KEY, JSON.stringify(state));
        }

        function load() {
            const data = JSON.parse(localStorage.getItem(KEY));
            
            // ëª¨ë“œ ë³µì›
            if(data && data.mode) { 
                mode = data.mode; 
                const radio = document.querySelector(`input[value="${mode}"]`);
                if(radio) radio.checked = true;
            }
            
            // ì²´í¬ ìƒíƒœ ë³µì›
            if(data && data.checked) {
                data.checked.forEach(rid => {
                    const cb = document.querySelector(`.chk[data-rid="${rid}"]`);
                    if(cb && !cb.disabled) { 
                        cb.checked = true; 
                        const row = document.getElementById(rid);
                        if(row) row.classList.add('completed'); 
                    }
                });
            }
            updateView();
        }

        function reset() {
            if(confirm('í™”ë©´ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (DB ì €ì¥ ë°ì´í„° ì œì™¸)')) { 
                localStorage.removeItem(KEY); 
                location.reload(); 
            }
        }

        function exportJson() {
            let data = {};
            document.querySelectorAll('input.chk').forEach(cb => {
                // ì²´í¬ë˜ì–´ ìˆê³ , data-keyê°€ ìˆëŠ” í•­ëª©ë§Œ ìˆ˜ì§‘
                if (cb.checked && cb.getAttribute('data-key')) {
                    data[cb.getAttribute('data-key')] = true;
                }
            });
            
            let fileName = "checklist_update_{{ year }}_{{ month_pad }}.json";
            let blob = new Blob([JSON.stringify(data, null, 4)], {type: "application/json"});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</head>
<body>
    <h2>âœ… {{ year }}ë…„ {{ month }}ì›” ì¦ë¹™ì„œë¥˜ ì œì¶œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
    
    <div class="controls">
        <div class="mode-group">
            <span>ğŸ‘ï¸ ë³´ê¸° ëª¨ë“œ: </span>
            <label><input type="radio" name="vm" value="strike" checked onclick="setMode('strike')"> ì·¨ì†Œì„ </label>
            <label><input type="radio" name="vm" value="hide" onclick="setMode('hide')"> ìˆ¨ê¸°ê¸°</label>
        </div>
        <div class="btn-group">
            <button class="btn-save" onclick="exportJson()">ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥(JSON)</button>
            <button class="btn-reset" onclick="reset()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th width="40">ì—°ë²ˆ</th>
                <th width="50">í™•ì¸</th>
                <th width="15%">ê¸°ê°„</th>
                <th width="50">ë²ˆí˜¸</th>
                <th width="80">ì„±ëª…</th>
                <th width="20%">êµ¬ë¶„</th>
                <th>ì‚¬ìœ </th>
            </tr>
        </thead>
        <tbody>
            {% if not rows %}
            <tr><td colspan="7">ì œì¶œ ëŒ€ìƒ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% else %}
            {% for row in rows %}
            <tr id="{{ row.rid }}" class="data-row {{ 'submitted' if row.is_done else '' }}">
                <td class="col-idx">{{ row.idx }}</td>
                <td>
                    <input type="checkbox" class="chk" 
                           data-key="{{ row.data_key }}" 
                           data-rid="{{ row.rid }}"
                           {{ 'checked disabled' if row.is_done else '' }} 
                           onclick="toggle(this, '{{ row.rid }}')">
                </td>
                <td class="period">{{ row.period_str }}</td>
                <td>{{ row.num }}</td>
                <td>{{ row.name }}</td>
                <td>
                    {{ row.type }}
                    {% if row.time %}
                    <span class="time-badge">{{ row.time }}</span>
                    {% endif %}
                </td>
                <td class="reason-cell">{{ row.reason }}</td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</body>
</html>