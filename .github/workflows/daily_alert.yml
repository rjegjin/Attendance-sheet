name: Daily Attendance Briefing (Double Check)

on:
  schedule:
    # 1. 아침 브리핑: 한국 시간 07:30 (UTC 22:30)
    - cron: '00 22 * * 0-4'
    # 2. 오후 브리핑: 한국 시간 17:00 (UTC 08:00)
    - cron: '0 8 * * 0-4'
  workflow_dispatch: # 수동 실행 버튼 유지

jobs:
  run-daily-bot:
    runs-on: ubuntu-latest
    steps:
      - name: 저장소 코드 체크아웃
        uses: actions/checkout@v3

      # [방학 기간 체크] 26.01.09 ~ 03.02 실행 중단 로직
      - name: 방학 기간 및 시간 파악
        shell: bash
        run: |
          # 한국 시간 기준 날짜와 시간 추출
          KST_DATE=$(date -d "+9 hours" +%Y%m%d)
          KST_HOUR=$(date -d "+9 hours" +%H)
          
          START_DATE="20260109"
          END_DATE="20260302"

          # 1. 방학 기간인지 확인
          if [[ "$KST_DATE" -ge "$START_DATE" && "$KST_DATE" -le "$END_DATE" ]]; then
            echo "현재 방학 기간($KST_DATE)입니다. 작업을 스킵합니다."
            echo "SKIP_RUN=true" >> $GITHUB_ENV
          else
            echo "SKIP_RUN=false" >> $GITHUB_ENV
          fi

          # 2. 현재 실행 시점이 아침인지 오후인지 구분 (로그용)
          if [ "$KST_HOUR" -lt 12 ]; then
            echo "RUN_TYPE=Morning" >> $GITHUB_ENV
          else
            echo "RUN_TYPE=Evening" >> $GITHUB_ENV
          fi

      - name: 파이썬 설정 (3.11)
        if: env.SKIP_RUN != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 라이브러리 설치
        if: env.SKIP_RUN != 'true'
        run: |
          pip install -r requirements.txt

      - name: 구글 인증 키 파일 생성
        if: env.SKIP_RUN != 'true'
        run: |
          cat <<EOF > service_key.json
          ${{ secrets.GOOGLE_JSON_KEY }}
          EOF

      - name: 봇 실행 (${{ env.RUN_TYPE }})
        if: env.SKIP_RUN != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo ">>> 현재 실행 모드: ${{ env.RUN_TYPE }} 브리핑"
          python daily_alert_system.py
